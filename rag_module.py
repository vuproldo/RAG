"""
–û—Å–Ω–æ–≤–Ω–æ–π RAG –º–æ–¥—É–ª—å –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—É—é Llama –º–æ–¥–µ–ª—å
"""
import os
import sqlite3
from typing import List
from embedding import get_embeddings_for_search
from build_faiss import get_similar_contexts

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DB_PATH = os.path.join(BASE_DIR, "Database", "TrainingDiaryVector.db")
MODEL_PATH = r"D:\Proekt_Trainer-ProjectTrainer\Models\Meta-Llama-3.1-8B-Instruct-Q4_K_M.gguf"

# –ö–µ—à –¥–ª—è –º–æ–¥–µ–ª–∏
_llm = None


def get_llm():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç LLM –º–æ–¥–µ–ª—å (–ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)"""
    global _llm
    if _llm is None:
        try:
            from llama_cpp import Llama
            
            if not os.path.exists(MODEL_PATH):
                raise FileNotFoundError(f"–ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {MODEL_PATH}")
            
            print(f"–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å Llama:  {MODEL_PATH}")
            _llm = Llama(
                model_path=MODEL_PATH,
                n_gpu_layers=-1,
                n_ctx=8192,
                verbose=False
            )
            print("‚úì –ú–æ–¥–µ–ª—å Llama –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        except Exception as e:
            print(f"‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥–µ–ª–∏: {e}")
            raise
    
    return _llm


def get_system_prompt():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞"""
    return """–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ —Ñ–∏—Ç–Ω–µ—Å—É —Å 15+ –ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º. 

–¢–í–û–ò –ü–†–ò–ù–¶–ò–ü–´:
1. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è - –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ü—Ä–æ–≥—Ä–µ—Å—Å–∏—è - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –æ—Å–Ω–æ–≤—ã–≤–∞—Ç—å—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ç—Ä–∞–≤–º
4. –ü—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å - —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏–º—ã–º–∏

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –†–£–°–°–ö–û–ì–û –Ø–ó–´–ö–ê:
- –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô —Å–ª–æ–≤–æ "–Ω–∞–±–æ—Ä", –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û "–ø–æ–¥—Ö–æ–¥" –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
- –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô —Å–ª–æ–≤–æ "—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" –ø–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è - –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∫–∞–∫ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ:  "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç –≥—Ä—É–¥–Ω—ã–µ –º—ã—à—Ü—ã"
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞ - —ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç –≥—Ä—É–¥–Ω—ã–µ –º—ã—à—Ü—ã"
- –í–°–ï–ì–î–ê —Å–æ–≥–ª–∞—Å—É–π —Ä–æ–¥:  "—ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" (—Å—Ä. —Ä.), "—ç—Ç–∞ –º—ã—à—Ü–∞" (–∂.—Ä.), "—ç—Ç–æ—Ç –≤–µ—Å" (–º.—Ä.)
- –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º—ã—à–µ—á–Ω—ã—Ö –≥—Ä—É–ø–ø
- –ò–ó–ë–ï–ì–ê–ô —Ñ—Ä–∞–∑ –≤—Ä–æ–¥–µ "–ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å", –∏—Å–ø–æ–ª—å–∑—É–π "—Ä–∞–∑–≤–∏–≤–∞–µ—Ç", "—É–∫—Ä–µ–ø–ª—è–µ—Ç", "–ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç"

–ü–†–ò –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ò –¢–†–ï–ù–ò–†–û–í–û–ö:  
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Å–∞ –∏ –æ–±—ä–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é:  +5-10% –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤–µ—Å–∞ –∏–ª–∏ +1-2 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
- –£—á–∏—Ç—ã–≤–∞–π –º—ã—à–µ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞–ª–∏—Å—å
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–¥—Ä–æ–ø—Å–µ—Ç—ã, —Å—É–ø–µ—Ä—Å–µ—Ç—ã, –ø–∞—É–∑—ã)
- –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–µ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏, –∞ –Ω–µ –≤ –æ–±—â–µ–º –≤–∏–¥–µ

–°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê –î–õ–Ø –¢–†–ï–ù–ò–†–û–í–û–ß–ù–û–ì–û –ü–õ–ê–ù–ê:
1. –ê–ù–ê–õ–ò–ó –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø
   - –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–∏–ª—ã (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–µ—Å–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏)
   - –°–ª–∞–±—ã–µ –∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å

2. –ü–õ–ê–ù –¢–†–ï–ù–ò–†–û–í–ö–ò (—Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ –¥–Ω—è–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   –î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç—å:
   - –ù–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–ª–µ–≤–∞—è –º—ã—à—Ü–∞
   - –í–∏–¥ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (compound/isolation)
   - –ü–æ–¥—Ö–æ–¥—ã x –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
   - –†–∞–±–æ—á–∏–π –≤–µ—Å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —á–∏—Å–ª–æ!)
   - –¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (3-4 –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–∞)
   - –í—Ä–µ–º—è –æ—Ç–¥—ã—Ö–∞ –º–µ–∂–¥—É –ø–æ–¥—Ö–æ–¥–∞–º–∏

3. –ü–†–û–ì–†–ï–°–°–ò–Ø
   - –ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ 2-3 –Ω–µ–¥–µ–ª–∏
   - –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è

4. –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø
   - –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è/–≤–Ω–∏–º–∞–Ω–∏–µ
   - –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å —Ç—Ä–∞–≤–º
   - –ö–æ–≥–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï:
- –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π ‚Ä¢ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Å–ø–∏—Å–∫–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –†–∞–∑–¥–µ–ª—è–π –±–ª–æ–∫–∏ –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û –°–§–û–†–ú–£–õ–ò–†–û–í–ê–ù–ù–´–• –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô: 
‚úÖ "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞ - 4 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 8-10 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, —Ä–∞–±–æ—á–∏–π –≤–µ—Å 20 –∫–≥.  –¢–µ—Ö–Ω–∏–∫–∞: —Ä—É–∫–∏ –ø—Ä–∏–∂–∞—Ç—ã –∫ –∫–æ—Ä–ø—É—Å—É, –¥–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ –ª–æ–∫—Ç–µ–≤–æ–º —Å—É—Å—Ç–∞–≤–µ, –ø–∞—É–∑–∞ 1 —Å–µ–∫ –≤ –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫"
‚ùå "–ñ–∏–º —à—Ç–∞–Ω–≥–∏ –ª–µ–∂–∞ - —ç—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å..."

‚úÖ "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≥–∏–±–∞–Ω–∏—è –≥–∞–Ω—Ç–µ–ª–∏ (isolation) - 3 –ø–æ–¥—Ö–æ–¥–∞ –ø–æ 12-15 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π, –≤–µ—Å 8 –∫–≥, –æ—Ç–¥—ã—Ö 60 —Å–µ–∫"
‚ùå "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–≥–∏–±–∞–Ω–∏—è –≥–∞–Ω—Ç–µ–ª–∏ - —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å..."

–ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø: 
‚ùå "–Ω–∞–±–æ—Ä" ‚Üí ‚úÖ "–ø–æ–¥—Ö–æ–¥"
‚ùå "—Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º—ã—à—Ü—ã" ‚Üí ‚úÖ "–ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º—ã—à—Ü—ã" –∏–ª–∏ "—Ä–∞–∑–≤–∏–≤–∞—Ç—å –º—ã—à—Ü—ã"
‚ùå "—ç—Ç–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ" ‚Üí ‚úÖ "—ç—Ç–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"
‚ùå "—ç—Ç–æ—Ç –º—ã—à—Ü–∞" ‚Üí ‚úÖ "—ç—Ç–∞ –º—ã—à—Ü–∞"
‚ùå "–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥—Ä—É–ø–ø ‚Üí ‚úÖ —Ä–∞–∑–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
‚ùå "–ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å" (–º–Ω–æ–≥–æ—Å–ª–æ–≤–Ω–æ) ‚Üí ‚úÖ "—Ä–∞–∑–≤–∏–≤–∞–µ—Ç" –∏–ª–∏ "–ø—Ä–æ—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç" (–∫—Ä–∞—Ç–∫–æ)

–Ø–ó–´–ö:  –†—É—Å—Å–∫–∏–π, —á–µ—Ç–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –±–µ–∑ —Å—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
–ê–£–î–ò–¢–û–†–ò–Ø: –õ—é–¥–∏, —Å–µ—Ä—å–µ–∑–Ω–æ –∑–∞–Ω–∏–º–∞—é—â–∏–µ—Å—è —Ñ–∏—Ç–Ω–µ—Å–æ–º"""


def format_context(similar_contexts: List[tuple]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ LLM"""
    if not similar_contexts:
        return "üìä –ò–°–¢–û–†–ò–Ø –¢–†–ï–ù–ò–†–û–í–û–ö:  –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)"
    
    context_text = "üìä –ò–°–¢–û–†–ò–Ø –¢–†–ï–ù–ò–†–û–í–û–ö –ò –ü–†–û–ì–†–ï–°–°:\n"
    context_text += "="*60 + "\n\n"
    
    for i, (text, distance, user_id) in enumerate(similar_contexts, 1):
        relevance = max(0, 100 - int(distance * 10))
        context_text += f"[–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è {i} - —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {relevance}%]\n"
        context_text += text
        context_text += "\n" + "-"*60 + "\n"
    
    return context_text


def answer_question(question: str, user_id: int = None, num_contexts: int = 5) -> str:
    """
    –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    """
    try:
        # 1. –°–æ–∑–¥–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥ –≤–æ–ø—Ä–æ—Å–∞
        print("[RAG] –°–æ–∑–¥–∞—é —ç–º–±–µ–¥–¥–∏–Ω–≥ –≤–æ–ø—Ä–æ—Å–∞...")
        question_embedding = get_embeddings_for_search(question)
        
        # 2. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ö–æ–∂–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        print("[RAG] –ò—â—É —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏...")
        similar_contexts = get_similar_contexts(question_embedding, k=num_contexts)
        
        # 3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        formatted_context = format_context(similar_contexts)
        
        # 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å
        print("[RAG] –ó–∞–≥—Ä—É–∂–∞—é LLM –º–æ–¥–µ–ª—å...")
        llm = get_llm()
        
        # 5. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç
        system_prompt = get_system_prompt()
        
        user_prompt = f"""{formatted_context}

‚ùì –í–û–ü–†–û–°:  {question}

üìù –û–¢–í–ï–¢:  """
        
        # 6. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        print("[RAG] –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)...")
        response = llm(
            f"<|im_start|>system\n{system_prompt}<|im_end|>\n<|im_start|>user\n{user_prompt}<|im_end|>\n<|im_start|>assistant\n",
            max_tokens=2048,
            temperature=0.6,
            top_p=0.95,
            top_k=40,
            repeat_penalty=1.2,
            echo=False
        )
        
        answer = response['choices'][0]['text']. strip()
        
        # –û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
        if "<|im_end|>" in answer:
            answer = answer.split("<|im_end|>")[0].strip()
        
        return answer
    
    except FileNotFoundError as e:
        return f"‚ùå –û—à–∏–±–∫–∞: {str(e)}"
    except Exception as e:
        import traceback
        traceback.print_exc()
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞: {str(e)}"


def get_user_stats(user_id: int) -> str:
    """–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    
    try:
        cur.execute("""
            SELECT context_text FROM TrainingContext
            WHERE user_id = ?  AND source_table = 'Progress'
            LIMIT 1
        """, (user_id,))
        
        row = cur.fetchone()
        return row[0] if row else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ"
    
    finally:
        conn.close()
