import sys
import importlib
import platform
import subprocess

REQUIRED_PYTHON = (3, 9)

REQUIRED_PACKAGES = {
    "numpy": "numpy",
    "sentence_transformers": "sentence-transformers",
    "faiss": "faiss-cpu",
    "llama_cpp": "llama-cpp-python"
}


def run(cmd):
    subprocess.run(cmd, shell=True, check=False)


def check_python():
    print("üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python...")
    if sys.version_info < REQUIRED_PYTHON:
        print(f"‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Python {REQUIRED_PYTHON[0]}.{REQUIRED_PYTHON[1]}+")
        print(f"   –ù–∞–π–¥–µ–Ω: {sys.version.split()[0]}")
        sys.exit(1)
    print(f"‚úÖ Python {sys.version.split()[0]}")


def check_and_install_packages():
    print("\nüîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...")
    missing = []

    for module, pip_name in REQUIRED_PACKAGES.items():
        try:
            importlib.import_module(module)
            print(f"‚úÖ {module}")
        except ImportError:
            print(f"‚ùå {module}")
            missing.append(pip_name)

    if missing:
        print("\nüì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–∫–µ—Ç—ã:")
        cmd = f"{sys.executable} -m pip install " + " ".join(missing)
        print(cmd)
        run(cmd)


def check_faiss():
    print("\nüîé –ü—Ä–æ–≤–µ—Ä–∫–∞ FAISS...")
    try:
        import faiss
        faiss.IndexFlatIP(4)
        print("‚úÖ FAISS —Ä–∞–±–æ—Ç–∞–µ—Ç")
    except Exception as e:
        print("‚ùå FAISS –ø—Ä–æ–±–ª–µ–º–∞:", e)
        sys.exit(1)


def check_llama():
    print("\nüîé –ü—Ä–æ–≤–µ—Ä–∫–∞ llama-cpp...")
    try:
        from llama_cpp import Llama
        print("‚úÖ llama-cpp-python —Ä–∞–±–æ—Ç–∞–µ—Ç")
    except Exception as e:
        print("‚ùå llama-cpp-python –æ—à–∏–±–∫–∞:", e)
        sys.exit(1)


def check_platform():
    print("\nüíª –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:")
    print(f"OS: {platform.system()} {platform.release()}")
    print(f"CPU: {platform.processor()}")


def main():
    print("=== RAG Environment Auto-Check ===\n")
    check_python()
    check_and_install_packages()
    check_faiss()
    check_llama()
    check_platform()
    print("\n‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ.\n")


if __name__ == "__main__":
    main()
